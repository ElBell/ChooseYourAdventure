 {% extends 'base.html' %}

 {% block title %}
     Game: {{ game.title }}
 {% endblock %}

{% block content %}
    <h3>{{ game.title }}</h3>
    <p>{{  game.description }}</p>

    <div id='fake-progress' class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 50%"></div>
    </div>

    <!-- Brython Libraries -->
    <script type="text/javascript" src="../../static/js/vendor/brython/brython.js"></script>
    <script type="text/javascript" src="../../static/js/vendor/brython/brython_stdlib.js"></script>
    <script>
    document.getElementById('fake-progress').remove();
    window.GAMES = {};
    function evalPython(src) {
        __BRYTHON__.debug = 1;
        __BRYTHON__.curdir = ''; // Serious bug: need to set this or can't import os
        try {
            eval(__BRYTHON__.python_to_js(src));
        } catch (err) {
            for (let key of Object.keys(err)) {
                console.log(err[key]);
            }
            console.log(err);
        }
    }
    </script>
    
    <style>
    
    .game-terminal {
        width: 80ch;
        height: 40ch;
        white-space: pre;
        background-color: #f9f1e5;
        font-family: Luminari, Chalkduster, monospace;
        overflow-y: auto;
        padding: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
        border: 1px solid #E9E1D5;
    }

    .game-error {
        font-family: monospace;
        white-space: pre;
        width: 80ch;
    }
    
    </style>
    
    <script>
    // Main entry point
    function Game(targetId, gameCode) {
        this.targetId = targetId;
        this.target = $("#"+targetId);
        this.code = gameCode;
        this.started = false;
        this.fadeQueue = $({});
        this.registerGame();
        this.createInterface();
        this.registerHandlers();
    }

    Game.prototype.registerGame = function() {
        if (typeof window.GAMES === undefined) {
            window.GAMES = {};
        }
        window.GAMES[this.targetId] = {
            'code': this.code,
            'end': this.stop.bind(this),
            'scroll': this.scrollTerminal.bind(this),
            'triggerFade': this.triggerFade.bind(this),
        }
    }

    Game.prototype.triggerFade = function(ele, speed) {
        let fadeQueue = this.fadeQueue;
        fadeQueue.queue(function (next) {
           $(ele.elt).fadeIn(speed, fadeQueue.dequeue.bind(fadeQueue));
        });
    }
    
    Game.prototype.registerHandlers = function() {
        this.target.find('.game-start').click(this.handleStartStop.bind(this));
    }
    
    Game.prototype.createInterface = function() {
        let interfaceComponents = [
            this.createButtons(),
            this.createErrorArea(),
            this.createTerminal(),
            this.createInputs()
        ];
        this.target.html($(interfaceComponents.join("\n")));
    }
    
    Game.prototype.createButtons = function() {
        return [
        "<button type='button' class='btn btn-success game-start'>Start</button>",
        ].join("\n");
    }
    
    Game.prototype.createTerminal = function() {
        return [
        "<div class='game-terminal'><div class='game-lines'>",
            "</div>",
            "<div class='game-cap'>",
            "</div>",
        "</div>"
        ].join("\n");
    }

    Game.prototype.createErrorArea = function() {
        return [
        "<div class='game-error alert alert-danger' style='display:none'>",
        "</div>"
        ].join("\n");
    }
    
    Game.prototype.createInputs = function() {
        return [
        "<span class='game-directions' style='display:none'>Choose an option...<span>",
        "<div class='list-group game-selectors'>",
        "</div>",
        "<span class='game-directions' style='display:none'>... or type your command:</span>",
        "<label for='game-input'></label>",
        "<div class='input-group mb-3'>",
            "<input disabled class='game-input form-control' autocomplete='off'>",
            "<div class='input-group-append'>",
                "<button type='button' disabled class='btn btn-info game-enter'>Enter</button>",
            "</div>",
        "</div>",
        ].join("\n");
    };

    Game.prototype.scrollTerminal = function() {
        let terminal = this.target.find('.game-terminal');
        terminal.delay(100).animate({
            scrollTop: terminal[0].scrollHeight //- terminal[0].clientHeight
        }, 3000);
    };

    function toPy(data) {
        return JSON.stringify(data);
    }

    Game.prototype.showError = function(message) {
        this.target.find('.game-error').show();
        this.target.text(message);
    }

    Game.prototype.ENGINE = [
        "from browser.html import BR, DIV",
        "from browser import window",
        "jq = window.jQuery",
        //"q = jq({})",
        //"previous = None",
        "def __fadeLines(lines, speed=100):",
        //"    global previous",
        "    for i, line in enumerate(lines.split(chr(10))):",
        "        text = DIV(line, style={'display': 'none'})",
        "        __terminal <= text",
        "        __triggerFade(text, speed)",
        /*"        if previous is None:",
        "            previous = jq(text).fadeIn(1000)",
        "            __terminal <= previous",
        "        else:",
        "            previous = previous.delay(100).fadeIn(1000)",
        "            __terminal <= previous",*/
        //"        jq(text).delay(i*400).fadeIn(1000)",
        "__terminal.text = ''",
        "__fadeLines(render_introduction(), 300)",
        "world = create_world()",
        "draw_speed = 300",
        "def __draw_world(world):",
        "    global draw_speed",
        "    __fadeLines(render(world), draw_speed)",
        "    draw_speed = 100",
        //"    __cap.scrollIntoView({'behavior': 'smooth'})",
        //"    __input.scrollIntoView({'behavior': 'smooth'})",
        "    __scroll()",
        "    options = get_options(world)",
        // Do autocomplete and selectable buttons
        "    for index, option in enumerate(options):",
        "        __selectors <= DIV(option, Class='list-group-item list-group-item-action')",
        "    for item in __selectors.select('div'):",
        "        item.bind('click', __handle_click)",
        "def __handle_click(event):",
        //"    __terminal <= str(event.target.text)",
        "    __handle_command(event.target.text)",
        "__draw_world(world)",
        "def __handle_submit(event):",
        "    command = __input.value",
        "    __handle_command(command)",
        "def __handle_command(command):",
        "    __fadeLines(update(world, command))",
        //"    __cap.scrollIntoView({'behavior': 'smooth'})",
        //"    __input.scrollIntoView({'behavior': 'smooth'})",
        "    __selectors.html = ''",
        "    __input.value = ''",
        "    if world['status'] == 'playing':",
        "        __draw_world(world)",
        "    else:",
        "        __fadeLines(render_ending(world))",
        "        __scroll()",
        "        __finish(event)",
        "def __finish(event):",
        "    __enter.unbind('click', __handle_submit)",
        "    __input.unbind('keypress', __handle_enter)",
        "    __stop.unbind('click', __finish)",
        "    __end()",
        "def __handle_enter(event):",
        "    if event.charCode == 13:",
        "        __handle_command(event)",
        "",
        "__enter.bind('click', __handle_submit)",
        "__input.bind('keypress', __handle_enter)",
        "__stop.bind('click', __finish)",
    ].join("\n");

    Game.prototype.handleStartStop = function() {
        if (this.started) {
            this.stop();
        } else {
            this.start();
        }
        this.started = !this.started;
    }
    
    Game.prototype.start = function() {
        this.target.find(".game-error").hide();
        this.target.find('.game-directions').show();
        this.target.find(".game-lines").text("Game loading - please wait!");
        this.target.find(".game-start").text("Stop").removeClass("btn-success").addClass("btn-danger");
        this.target.find(".game-input").val('').prop('disabled', false);
        this.target.find(".game-enter").prop('disabled', false);
        this.target.find(".game-selectors").html("");
        setTimeout(() => {
            this.run();
        }, 300);
    }

    Game.prototype.run = function() {
        let gameRunner = [
            'from browser import window, document',
            'import traceback',
            'root = '+toPy(this.targetId),
            // HTML components
            "terminal = document[root].select('.game-lines')[0]",
            "cap = document[root].select('.game-cap')[0]",
            "input = document[root].select('.game-input')[0]",
            "enter = document[root].select('.game-enter')[0]",
            "error = document[root].select('.game-error')[0]",
            "stop = document[root].select('.game-start')[0]",
            "selectors = document[root].select('.game-selectors')[0]",
            // JS Data
            "code = window['GAMES'][root]['code']",
            "gameWindow = window['GAMES'][root]",
            "end = window['GAMES'][root]['end']",
            "scroll = window['GAMES'][root]['scroll']",
            "triggerFade = window['GAMES'][root]['triggerFade']",
            // Injecting student code
            "code = code[:code.find('def main():')]",
            "code = code + '''"+this.ENGINE+"'''",
            // Execute
            "compiled = compile(code, '__main__', 'exec')",
            "sandbox = {'__terminal': terminal, '__input': input, ",
            "           '__enter': enter, '__cap': cap, '__end': end,",
            "           '__stop': stop, '__selectors': selectors, ",
            "           '__scroll': scroll, '__triggerFade': triggerFade}",
            "try:",
            "    exec(compiled, sandbox)",
            "except Exception as err:",
            "    message = traceback.format_exc()",
            "    error.text = message",
            "    error.style.display = 'block'",
            // TODO: Error state would leave the handlers open
            ""
        ].join("\n");
        console.log(gameRunner + "/n");
        console.log(evalPython(gameRunner));
    }
    
    Game.prototype.stop = function() {
        this.target.find(".game-input").prop('disabled', true);
        this.target.find(".game-enter").prop('disabled', true);
        this.target.find('.game-directions').hide();
        this.target.find(".game-selectors").html("");
        this.target.find(".game-start").text("Start").addClass("btn-success").removeClass("btn-danger");
        this.started = false;
    }
    
    $(document).ready(function() {
        let gameCode = document.getElementById('source-code').innerText;
        let root = 'main-game';
        main = new Game(root, gameCode);
    });
    
    </script>
    
    <!-- Play Zone -->
    <div id="main-game">
    Loading main game engine...
    </div>
    
    <pre id="source-code" class='d-none'>{{ game.code }}</pre>

{% endblock %}